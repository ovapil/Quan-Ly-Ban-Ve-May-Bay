<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UITicket - T√†i kho·∫£n</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Asap:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <style>
    /* ===== SETTINGS MODAL PAGE ===== */
    .page.settings-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 50px;
    }

    .settings-greeting-section {
      text-align: center;
      margin-bottom: 20px;
      margin-top: 80px;
    }

    .settings-avatar {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      margin: 0 auto 25px;
      border: 5px solid var(--primary);
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .settings-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .settings-avatar i {
      font-size: 60px;
      color: var(--primary);
    }

    .settings-greeting {
      font-size: 36px;
      font-weight: 800;
      color: var(--text);
      margin: 0;
      line-height: 1.2;
    }

    /* ===== SETTINGS CARDS ===== */
    .settings-cards {
      display: grid;
      gap: 24px;
      max-width: 700px;
      width: 100%;
    }

    .settings-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .settings-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .settings-card-content {
      flex: 1;
    }

    .settings-card-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
      margin: 0 0 8px 0;
    }

    .settings-card-desc {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
      line-height: 1.5;
    }

    .settings-card-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 36px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      margin-left: 24px;
    }

    .settings-card-btn:hover {
      background: #1e3a8a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(46,74,168,0.3);
    }

    .settings-card-btn:active {
      transform: translateY(0);
    }

    /* ===== SETTINGS MODAL ===== */
    .settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .settings-modal.show {
      display: flex;
    }

    .settings-modal-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      max-width: 480px;
      width: 90vw;
      overflow: hidden;
      animation: modalSlideUp 0.3s ease-out;
    }

    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .settings-modal-head {
      padding: var(--pad);
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-modal-head h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .settings-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--muted);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-modal-close:hover {
      color: var(--text);
      background: #f1f5f9;
      border-radius: 8px;
    }

    .settings-modal-body {
      padding: var(--pad);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #f8fafc;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(46,74,168,0.1);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 28px;
    }

    .form-btn {
      padding: 10px 22px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .form-btn.primary {
      background: var(--primary);
      color: white;
    }

    .form-btn.primary:hover {
      background: #1e3a8a;
    }

    .form-btn.secondary {
      background: #f1f5f9;
      color: var(--text);
    }

    .form-btn.secondary:hover {
      background: #e2e8f0;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .page.settings-page {
        padding: 40px 20px;
      }

      .settings-card {
        flex-direction: column;
        text-align: center;
      }

      .settings-card-btn {
        margin-left: 0;
        margin-top: 20px;
        width: 100%;
      }

      .settings-greeting {
        font-size: 28px;
      }

      .settings-avatar {
        width: 110px;
        height: 110px;
        font-size: 48px;
      }
    }
  </style>
</head>

<body class="app-mode">
  <div id="toast">Th√¥ng b√°o</div>

  <header class="app-header">
    <div class="bar">
      <!-- BRAND -->
      <div class="brand">
        <img class="brand-logo-img" src="assets/images/logo.png" alt="UITicket Logo" />
        <div class="name">
          <div class="title">UITicket</div>
          <div class="slogan">Buy&Fly. Catch your sky!</div>
        </div>
      </div>

      <!-- NAV -->
      <nav class="nav-tabs" aria-label="Main Navigation">
        <button class="tab" onclick="window.location='dashboard.html'">Trang ch·ªß</button>
        <button class="tab active">T√†i kho·∫£n</button>
        <button class="tab" onclick="settingsNav('settings')">C√†i ƒë·∫∑t</button>
      </nav>

      <!-- CLOSE BUTTON -->
      <div class="actions">
        <button class="icon-btn dropdown-btn" aria-label="Menu" onclick="UI.toggleMenu()">
          <i class="fa-solid fa-bars"></i>
          <div class="dropdown-menu hidden" id="dropdownMenu">
            <a href="#" onclick="window.location='dashboard.html'; return false;">üè† Trang ch·ªß</a>
            <a href="#" onclick="window.location='settings.html'; return false;">‚öôÔ∏è C√†i ƒë·∫∑t</a>
            <hr style="margin: 8px 0; border: none; border-top: 1px solid #e2e8f0;">
            <a href="#" onclick="showLogoutConfirm(); return false;" style="color: #ef4444;">üö™ ƒêƒÉng xu·∫•t</a>
          </div>
        </button>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="page settings-page">
    <div class="settings-greeting-section">
      <div id="settingsAvatar" class="settings-avatar">
        <img src="assets/images/avatar.png" alt="Avatar" onerror="this.style.display='none'" />
        <i class="fa-solid fa-user" id="avatarFallback"></i>
      </div>
      <h1 class="settings-greeting" id="settingsGreeting">Xin ch√†o, Ng∆∞·ªùi d√πng!</h1>
    </div>

    <div class="settings-cards">
      <!-- CHANGE PASSWORD -->
      <div class="settings-card">
        <div class="settings-card-content">
          <h3 class="settings-card-title">Thay ƒë·ªïi m·∫≠t kh·∫©u</h3>
          <p class="settings-card-desc">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u t√†i kho·∫£n c·ªßa b·∫°n tr√™n UITicket</p>
        </div>
        <button class="settings-card-btn" onclick="openChangePasswordModal()">Thay ƒë·ªïi</button>
      </div>

      <!-- CHANGE AVATAR -->
      <div class="settings-card">
        <div class="settings-card-content">
          <h3 class="settings-card-title">Ch·ªânh s·ª≠a ·∫£nh ƒë·∫°i di·ªán</h3>
          <p class="settings-card-desc">Thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán t√†i kho·∫£n c·ªßa b·∫°n tr√™n UITicket</p>
        </div>
        <button class="settings-card-btn" onclick="openChangeAvatarModal()">Ch·ªânh s·ª≠a</button>
      </div>
    </div>
  </main>

  <!-- MODAL: CHANGE PASSWORD -->
  <div id="changePasswordModal" class="settings-modal">
    <div class="settings-modal-card">
      <div class="settings-modal-head">
        <h3>Thay ƒë·ªïi m·∫≠t kh·∫©u</h3>
        <button class="settings-modal-close" onclick="closeChangePasswordModal()">√ó</button>
      </div>
      <div class="settings-modal-body">
        <div class="form-group">
          <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
          <input type="password" id="currentPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" />
        </div>

        <div class="form-group">
          <label>M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" />
        </div>

        <div class="form-group">
          <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
        </div>

        <div class="form-actions">
          <button class="form-btn secondary" onclick="closeChangePasswordModal()">Hu·ª∑</button>
          <button class="form-btn primary" onclick="submitChangePassword()">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: CHANGE AVATAR -->
  <div id="changeAvatarModal" class="settings-modal">
    <div class="settings-modal-card">
      <div class="settings-modal-head">
        <h3>Ch·ªânh s·ª≠a ·∫£nh ƒë·∫°i di·ªán</h3>
        <button class="settings-modal-close" onclick="closeChangeAvatarModal()">√ó</button>
      </div>
      <div class="settings-modal-body">
        <div class="form-group">
          <label>URL ·∫£nh</label>
          <input type="text" id="avatarUrl" placeholder="Nh·∫≠p URL ·∫£nh ƒë·∫°i di·ªán" />
        </div>

        <div class="form-group">
          <label>Ho·∫∑c t·∫£i ·∫£nh l√™n</label>
          <input type="file" id="avatarFile" accept="image/*" />
        </div>

        <div class="form-group">
          <p style="color: var(--muted); font-size: 12px; margin: 0;">
            ƒê·ªãnh d·∫°ng: JPG, PNG, GIF. K√≠ch th∆∞·ªõc t·ªëi ƒëa: 5MB
          </p>
        </div>

        <div class="form-actions">
          <button class="form-btn secondary" onclick="closeChangeAvatarModal()">Hu·ª∑</button>
          <button class="form-btn primary" onclick="submitChangeAvatar()">L∆∞u ·∫£nh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: SUCCESS NOTIFICATION -->
  <div id="successModal" class="settings-modal">
    <div class="settings-modal-card" style="max-width: 400px;">
      <div class="settings-modal-body" style="text-align: center; padding: 40px 30px;">
        <div style="margin-bottom: 20px;">
          <i class="fa-solid fa-circle-check" style="font-size: 60px; color: #10b981;"></i>
        </div>
        <h3 id="successTitle" style="margin: 20px 0 10px; font-size: 20px; font-weight: 700; color: var(--text);">
          Th√†nh c√¥ng!
        </h3>
        <p id="successMessage" style="margin: 0 0 30px; color: var(--muted); line-height: 1.5; font-size: 14px;">
          Thao t√°c c·ªßa b·∫°n ƒë√£ ho√†n t·∫•t.
        </p>
        <button class="form-btn primary" onclick="closeSuccessModal()" style="width: 100%;">
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize
    function initSettings() {
      const user = JSON.parse(localStorage.getItem('uiticket_user') || '{}');
      document.getElementById('settingsGreeting').textContent = 
        `Xin ch√†o, ${user.full_name || user.username || 'Ng∆∞·ªùi d√πng'}!`;
      
      if (user.avatar_url) {
        const img = document.getElementById('settingsAvatar').querySelector('img');
        img.src = user.avatar_url;
        img.style.display = 'block';
      }
    }

    function settingsNav(page) {
      if (page === 'settings') {
        window.location.href = 'settings.html';
      }
    }

    // Success Modal
    function showSuccessModal(title, message) {
      document.getElementById('successTitle').textContent = title;
      document.getElementById('successMessage').textContent = message;
      document.getElementById('successModal').classList.add('show');
    }

    function closeSuccessModal() {
      document.getElementById('successModal').classList.remove('show');
    }

    // Change Password
    function openChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.add('show');
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('show');
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    function submitChangePassword() {
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (!current || !newPass || !confirm) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }

      if (newPass.length < 6) {
        alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
        return;
      }

      if (newPass !== confirm) {
        alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
        return;
      }

      // G·ªçi API th·ª±c
      changePasswordAPI(current, newPass);
    }

    async function changePasswordAPI(currentPassword, newPassword) {
      const token = localStorage.getItem('uiticket_token');

      try {
        const response = await fetch('http://localhost:3000/api/user/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            currentPassword,
            newPassword
          })
        });

        const data = await response.json();

        if (!response.ok) {
          alert('‚ùå ' + (data.error || 'L·ªói thay ƒë·ªïi m·∫≠t kh·∫©u'));
          return;
        }

        showSuccessModal(
          '‚úÖ Th√†nh c√¥ng!',
          'M·∫≠t kh·∫©u ƒë√£ thay ƒë·ªïi th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.'
        );
        closeChangePasswordModal();
        
        // ƒêƒÉng xu·∫•t sau 2s
        setTimeout(() => {
          localStorage.removeItem('uiticket_token');
          localStorage.removeItem('uiticket_user');
          window.location.href = 'index.html';
        }, 2000);

      } catch (error) {
        console.error('Change password error:', error);
        alert('‚ùå L·ªói server: ' + error.message);
      }
    }

    // Change Avatar
    function openChangeAvatarModal() {
      document.getElementById('changeAvatarModal').classList.add('show');
    }

    function closeChangeAvatarModal() {
      document.getElementById('changeAvatarModal').classList.remove('show');
      document.getElementById('avatarUrl').value = '';
      document.getElementById('avatarFile').value = '';
    }

    function submitChangeAvatar() {
      const url = document.getElementById('avatarUrl').value;
      const file = document.getElementById('avatarFile').files[0];

      if (!url && !file) {
        alert('Vui l√≤ng nh·∫≠p URL ho·∫∑c ch·ªçn ·∫£nh');
        return;
      }

      // ∆Øu ti√™n file upload n·∫øu c√≥, kh√¥ng th√¨ d√πng URL
      if (file) {
        // X·ª≠ l√Ω file upload - convert to data URL
        const reader = new FileReader();
        reader.onload = (e) => {
          changeAvatarAPI(e.target.result);
        };
        reader.readAsDataURL(file);
        return;
      }

      if (url) {
        // G·ªçi API v·ªõi URL
        changeAvatarAPI(url);
        return;
      }
    }

    async function changeAvatarAPI(avatarUrl) {
      const token = localStorage.getItem('uiticket_token');

      try {
        const response = await fetch('http://localhost:3000/api/user/change-avatar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            avatar_url: avatarUrl
          })
        });

        const data = await response.json();

        if (!response.ok) {
          alert('‚ùå ' + (data.error || 'L·ªói c·∫≠p nh·∫≠t avatar'));
          return;
        }

        // C·∫≠p nh·∫≠t localStorage
        const user = JSON.parse(localStorage.getItem('uiticket_user') || '{}');
        user.avatar_url = avatarUrl;
        localStorage.setItem('uiticket_user', JSON.stringify(user));

        // C·∫≠p nh·∫≠t avatar hi·ªÉn th·ªã
        const avatarImg = document.getElementById('settingsAvatar').querySelector('img');
        avatarImg.src = avatarUrl;
        avatarImg.style.display = 'block';

        showSuccessModal(
          '‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!',
          '·∫¢nh ƒë·∫°i di·ªán c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.'
        );
        closeChangeAvatarModal();

      } catch (error) {
        console.error('Change avatar error:', error);
        alert('‚ùå L·ªói server: ' + error.message);
      }
    }

    // ƒê√≥ng modal khi click backdrop
    document.addEventListener('click', (e) => {
      if (e.target.id === 'changePasswordModal') {
        closeChangePasswordModal();
      }
      if (e.target.id === 'changeAvatarModal') {
        closeChangeAvatarModal();
      }
    });

    initSettings();
  </script>
</body>
</html>
